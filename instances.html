<!DOCTYPE html>
<html lang="en">

<head>
	<title>Instances</title>
	<link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/instances.css">
</head>

<body onload="loadInstances()">
	<div id="wrapper">
		<div id="tools">
			<button type="button" data-toggle="modal" data-target="#newInstanceModal" id="new" class="btn btn-success">New Instance</button>
			<button type="button" onclick="impInstance()" id="imp" class="btn btn-success">Import Instance</button>
			<button type="button" onclick="closeWindow()" id="close" class="btn btn-danger">Close</button>
		</div>
		<div id="instances"> <!--Load all instances when this div has loaded-->
			<!--Store instances-->
		</div>
		<div class="modal fade" id="newInstanceModal" tabindex="-1" role="dialog" aria-labelledby="newInstanceModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="newInstanceModalLabel">New Instance</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<input type="text" class="form-control" id="nameInput" aria-describedby="nameHelp" placeholder="Instance Name" required>
							<div class="form-control-feedback"></div>
						</div>
						<div class="form-group">
							<br>
							<button type="button" class="btn btn-primary" onclick="newInstanceImg()" id="img-choose">Select Icon</button>
							<br>
							<br>
							<img id="previewImg" width="64" height="64" src="assets/res/icon.png"></img>
						</div>
						<div class="form-group">
							<br>
							<button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true"
							 aria-expanded="false">
								Version
							</button>
							<div id="VersionList" class="dropdown-menu" aria-labelledby="VersionList">
								<script>
									//Populate this list with versions
									const request = require('request');
									const fs = require('fs');

									request('http://216.53.217.165:8080/FetchGameVersions', { json: true }, (err, res, body) => {

										if (err) {
											return console.log(err);
										}

										var versionList = body.toString().split(',');

										var i;
										for (i = 0; i < versionList.length; i++) {
											var temp = versionList[i].replace('.jar', '').replace('-', ' ');
											var version = temp.replace('Zerra ', '');
											document.getElementById("VersionList").innerHTML += '<a class="dropdown-item" id="' + version + '" href="#" onclick="newInstanceVersion(this)">' + temp + '</a>';
										}
									});

								</script>
								<a class="dropdown-item" id="latest" href="#" onclick="newInstanceVersion(this)">Latest</a>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<p id="alertText"></p>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-success" onclick="createInstance()" id="createInstance">Create</button>
					</div>
					<div class="progress">
						<div class="progress-bar" role="progressbar" id="DownloadProgress" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
					  </div>
				</div>
			</div>
		</div>
	</div>

	<script>
		window.jQuery = window.$ = require('jquery');

		const path = require('path');

		var zpath = 'C:/Users/' + process.env.username + '/AppData/Roaming/.zerra/Launcher/Instances/';

		var instances_holder = document.getElementById('instances');

		var Shuffle = require('shufflejs');

		var shuffle = new Shuffle(instances_holder, {
			itemSelector: '.instance',
			speed: 250,
			easing: 'ease',
			columnWidth: function (containerWidth) {
				return 128;
			},

			gutterWidth: function (containerWidth) {
				return 10;
			},
		});

		//!!Instance Loading!!
		function loadInstances(){
			fs.readdir(zpath, function(err, dirs){
				dirs.forEach(function(dir){
					fs.stat(zpath+"/"+dir, function(err, stats){ //Check for each instance
						if(stats.isDirectory()){ //Check if it's actually an instance/directory
							fs.readFile(zpath+"/"+dir+"/info.json", function(err, jdata){ //Load aaaaaalll data about the instance (json data)
								var data = JSON.parse(jdata); //UnJSONify

								//Instance Div
								var instance = document.createElement('div');
								instance.className = 'instance';
								instance.setAttribute("id", instances_holder.childElementCount);
								instance.addEventListener("onclick", openInstance(instance.getAttribute("id")));

								//Instance's Image
								var img = document.createElement('img');
								img.className = 'instance-img';
								img.src = zpath+"/"+dir+"/"+data.icon;

								console.log(data.icon);

								instance.appendChild(img);

								//Instance's Name
								var name = document.createElement('h1');
								name.className = 'instance-name';
								name.innerText = data.name;

								instance.appendChild(name);

								instances_holder.appendChild(instance);

								shuffle.add([instance]);
							});
						}
					})
				});
			});
		}
		//!!End Of Instance Loading!!

		//!!Instance Creation!!
		//Hold data of instance before creating one.
		var newInstance_name;
		var newInstance_pathimg = "assets/res/icon.png"; //Image's path, set a Zerra image path as default
		var newInstance_ver;

		function createInstance() {
			newInstance_name = $("#nameInput").val();
			if (newInstance_name && newInstance_name != "") { //Check if user filled out the name
				if (newInstance_name.length <= 32) {
					//No need to check the image, because it'll be a default one if not picked.
					if (newInstance_ver != null) { //Check if user picked a version
						if (!fs.existsSync(zpath + newInstance_name + "/")) { //Basically check if there is an instance with the same name
							//Instance Div
							var instance = document.createElement('div');
							instance.className = 'instance';
							instance.setAttribute("id", instances_holder.childElementCount);
							instance.addEventListener("onclick", openInstance(instance.getAttribute("id")));

							//Instance's Image
							var img = document.createElement('img');
							img.className = 'instance-img';
							img.src = newInstance_pathimg;

							instance.appendChild(img);

							//Instance's Name
							var name = document.createElement('h1');
							name.className = 'instance-name';
							name.innerText = newInstance_name;

							instance.appendChild(name);

							instances_holder.appendChild(instance);

							shuffle.add([instance]);

							fs.mkdir(zpath + newInstance_name + "/", { recursive: true }, function (err) {
								if (!err) {
									fs.copyFile(newInstance_pathimg, zpath + newInstance_name + "/icon" + path.extname(newInstance_pathimg), function (err) { //Save a logo
										if (!err) { //Only continue when there wasn't any error
											//Create folders for each instance
											fs.mkdir(zpath + newInstance_name + "/Saves", { recursive: true }, function(){ if(err){console.log(err)} });
											fs.mkdir(zpath + newInstance_name + "/Mods", { recursive: true }, function(){ if(err){console.log(err)} });
											fs.mkdir(zpath + newInstance_name + "/Servers", { recursive: true }, function(){ if(err){console.log(err)} });

											var tempPath = 'C:/Users/' + process.env.username + '/AppData/Roaming/.zerra/Launcher/Shared/Zerra-' + newInstance_ver + '.jar';

											if(!fs.existsSync(tempPath)) {
												if (newInstance_ver != 'latest') {
													var req = request('http://216.53.217.165:8080/Game/Zerra-' + newInstance_ver + '.jar');
												} else {
													var req = request('http://216.53.217.165:8080/Game/latest');
												}

												req.pipe(fs.createWriteStream(tempPath));

												var contentSize;
												req.on('response', function(response) {
													console.log(response.statusCode); // 200
													console.log('CONTENT SIZE - ' + response.headers['content-length']); // 'image/png'
													contentSize = response.headers['content-length'];
												});

												var progress = 0;
												var progressBar = document.getElementById("DownloadProgress");
												req.on('data', function (chunk) {
													var segment = chunk.length;
													progress += segment;
													progressBar.style.width = Math.ceil((progress / contentSize * 100)) + '%';
													
													console.log('PROGRESS - ' + (progress / contentSize * 100) + '%');

													if((progress / contentSize) == 1) {
														//Hide this modal. We are done downloading.
														setTimeout(function(){
															$('#newInstanceModal').modal('hide');
														}, 1000);
														
														//Reset the progress bar.
														setTimeout(function(){
															progressBar.style.width = 0 + '%';
														}, 1250);
														
													}
												});

												fs.writeFile(zpath + newInstance_name + "/info.json", infoToJSON(), 'utf8', function(err){ //Save the JSON file holding information about this instance
													if(err){
														console.log(err);
													}
												});
											}else {
												// Close the modal immediately, the file was already downloaded before.
												$('#newInstanceModal').modal('hide');
											}
										} else {
											console.log(err);
											$("#alertText").text("Couldn't save an instance image!");
										}
									});
								} else {
									$("#alertText").text("Couldn't create an instance directory!");
								}
							});
						} else {
							$("#alertText").text("An instance with that name already exists!");
						}
					} else {
						$("#alertText").text("No version selected!");
					}
				} else {
					$("#alertText").text("The instance name can be no greater than 32 characters!");
				}
			} else {
				$("#alertText").text("The name of the instance is not valid!");
			}
		}

		function newInstanceImg() {
			const { dialog } = require('electron').remote;
			const path = require('path');

			dialog.showOpenDialog({
				properties: ['openFile'],
				filters: [
					{
						"name": "Images",
						"extensions": ["png", "jpg", "jpeg", "bmp"]
					}
				],
				defaultPath: 'C:/Users/' + process.env.username + '/AppData/Roaming/.zerra/Instances/'
			}, function (files) {
				icon: path.join(__dirname, 'assets/res/icon.png')
				if (files !== undefined) {
					frame: false

					var img = new Image();
					img.src = files[0] + '?' + new Date().getTime();
					img.addEventListener("load", function() { //Only continue if the image has fully loaded
						if (img.width && img.height) { //Check if the image... well is something.
								if (img.width == img.height) {
									$("#previewImg").attr("src", files[0] + '?' + new Date().getTime());
									newInstance_pathimg = files[0];
								} else {
									$("#alertText").text("The selected icon's width does not equal its height!");
								}
						} else {
							$("#alertText").text("Selected image couldn't be loaded.");
						}
					});
				}
			});
		}

		function newInstanceVersion(element) {
			const { dialog } = require('electron').remote;
			const path = require('path');

			$("#dropdownMenuButton").text(element.id);

			newInstance_ver = element.id;
		}

		function infoToJSON() {
			var pinfo = { //Pure non JSON info
				name: newInstance_name,
				version: newInstance_ver,
				icon: "icon"+path.extname(newInstance_pathimg) //Make it relative to the launcher to make it "portable"
			};
			var info = JSON.stringify(pinfo); //JSONifny
			return info;
		}

		//!!End Of Instance Creation!!

		function openInstance(id) {
		}

		//Just close...
		function closeWindow() {
			const remote = require('electron').remote;
			var window = remote.getCurrentWindow();
			window.close();
		}
	</script>
	<script src="node_modules/popper.js/dist/umd/popper.js"></script>
	<script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
</body>

</html>